#!/usr/bin/env php
<?php

use Tivins\CIMachine\CICli;
use Tivins\CIMachine\CIMachine;
use Tivins\CIMachine\GitLocation;
use Tivins\Core\Log\CLILogger;
use Tivins\Core\Log\Level;
use Tivins\Core\OptionArg;
use Tivins\Core\OptionsArgs;

require __dir__ . '/../vendor/autoload.php';

$ciCLI = new CICli();

$options = (new OptionsArgs())
    ->add(new OptionArg('u', true, 'uri'))
    ->add(new OptionArg('b', true, 'branch'))
    ->add(new OptionArg('c', true, 'commit'))
    ->add(new OptionArg('p', true, 'php'))
    ->add(new OptionArg('v', true, 'verbose'))
    ->add(new OptionArg('h', long: 'help'))
    ->parse();

$logger = new CLILogger();

if (isset($options['help'])) {
    echo $ciCLI->usage();
    exit(0);
}

if (!isset($options['uri'])) {
    $logger->log(Level::DANGER, "URI is missing");
    echo $ciCLI->usage();
    die();
}
if (isset($options['verbose'])) {
    $logger->setLevel(Level::tryFrom($options['verbose']) ?? Level::DANGER);
}

// -- run

$location = new GitLocation(
        $options['uri'],
        $options['branch'] ?? GitLocation::BRANCH_DEFAULT,
        $options['commit'] ?? GitLocation::COMMIT_DEFAULT,
);
$machine = new CIMachine($location);
$machine->setLogger($logger);
$machine->setPhpVersion($options['php'] ?? CIMachine::PHP_LATEST);
$machine->runBackupClose();
$logger->info($machine->getRealOutDir());
